<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>创建模型 | 煎蛋</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link ref="icon" href="/img/favicon.ico">
    <script src="/lib/jQuery.min.js"></script>
    <meta name="description" content="兴趣使然的记录前端开发中的点点滴滴">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <link rel="preload" href="/assets/css/0.styles.ba80c229.css" as="style"><link rel="preload" href="/assets/js/app.c6a61154.js" as="script"><link rel="preload" href="/assets/js/2.b83c1193.js" as="script"><link rel="preload" href="/assets/js/17.7c6a7aa9.js" as="script"><link rel="prefetch" href="/assets/js/10.af35934f.js"><link rel="prefetch" href="/assets/js/11.cd42f045.js"><link rel="prefetch" href="/assets/js/12.8f2fbdf7.js"><link rel="prefetch" href="/assets/js/13.6b351a56.js"><link rel="prefetch" href="/assets/js/14.ea987d42.js"><link rel="prefetch" href="/assets/js/15.5a692030.js"><link rel="prefetch" href="/assets/js/16.66b6b1fd.js"><link rel="prefetch" href="/assets/js/18.d40b8053.js"><link rel="prefetch" href="/assets/js/19.af324401.js"><link rel="prefetch" href="/assets/js/20.9b0741a0.js"><link rel="prefetch" href="/assets/js/21.cdb45e96.js"><link rel="prefetch" href="/assets/js/22.c1498e5e.js"><link rel="prefetch" href="/assets/js/23.36856186.js"><link rel="prefetch" href="/assets/js/24.f3bec094.js"><link rel="prefetch" href="/assets/js/25.471e119d.js"><link rel="prefetch" href="/assets/js/26.9f69a506.js"><link rel="prefetch" href="/assets/js/27.e2246053.js"><link rel="prefetch" href="/assets/js/28.d8c2cdcd.js"><link rel="prefetch" href="/assets/js/29.d899ebfc.js"><link rel="prefetch" href="/assets/js/3.6263d150.js"><link rel="prefetch" href="/assets/js/30.09f5218f.js"><link rel="prefetch" href="/assets/js/31.73fcb01e.js"><link rel="prefetch" href="/assets/js/32.069c3ac8.js"><link rel="prefetch" href="/assets/js/33.f80eb311.js"><link rel="prefetch" href="/assets/js/34.c2017c6b.js"><link rel="prefetch" href="/assets/js/35.fb58fc47.js"><link rel="prefetch" href="/assets/js/36.1ac9067f.js"><link rel="prefetch" href="/assets/js/37.c922c3f4.js"><link rel="prefetch" href="/assets/js/38.357b8144.js"><link rel="prefetch" href="/assets/js/39.3fa92e7a.js"><link rel="prefetch" href="/assets/js/4.010ba7b6.js"><link rel="prefetch" href="/assets/js/40.a92d4e59.js"><link rel="prefetch" href="/assets/js/41.86960da2.js"><link rel="prefetch" href="/assets/js/42.84d1a089.js"><link rel="prefetch" href="/assets/js/43.53013c84.js"><link rel="prefetch" href="/assets/js/44.4f5f695c.js"><link rel="prefetch" href="/assets/js/45.bced3911.js"><link rel="prefetch" href="/assets/js/46.26e2d6e4.js"><link rel="prefetch" href="/assets/js/47.17a01b4e.js"><link rel="prefetch" href="/assets/js/48.74880426.js"><link rel="prefetch" href="/assets/js/49.3a727ef6.js"><link rel="prefetch" href="/assets/js/5.92209cd7.js"><link rel="prefetch" href="/assets/js/50.e65d747a.js"><link rel="prefetch" href="/assets/js/51.3db82190.js"><link rel="prefetch" href="/assets/js/52.bc99010b.js"><link rel="prefetch" href="/assets/js/53.a53149dd.js"><link rel="prefetch" href="/assets/js/54.84966951.js"><link rel="prefetch" href="/assets/js/55.32619148.js"><link rel="prefetch" href="/assets/js/56.1d1d5366.js"><link rel="prefetch" href="/assets/js/57.d3a9a3f3.js"><link rel="prefetch" href="/assets/js/58.fe2253af.js"><link rel="prefetch" href="/assets/js/6.2a08bac4.js"><link rel="prefetch" href="/assets/js/7.1a29169c.js"><link rel="prefetch" href="/assets/js/8.0690cd79.js"><link rel="prefetch" href="/assets/js/9.b9d8f4ad.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ba80c229.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">煎蛋</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端相关" class="dropdown-title"><span class="title">前端相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端相关" class="mobile-dropdown-title"><span class="title">前端相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/前端学习路线.html" class="nav-link">
  前端学习路线
</a></li><li class="dropdown-item"><!----> <a href="/frontend/css-notes/" class="nav-link">
  CSS学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/frontend/js-notes/" class="nav-link">
  JS学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/frontend/uni-app/" class="nav-link">
  uni-app学习笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端相关" class="dropdown-title"><span class="title">后端相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端相关" class="mobile-dropdown-title"><span class="title">后端相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/eggjs/" class="nav-link router-link-active">
  eggjs学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/backend/thinkphp/" class="nav-link">
  ThinkPHP学习笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Github" class="dropdown-title"><span class="title">Github</span> <span class="arrow down"></span></button> <button type="button" aria-label="Github" class="mobile-dropdown-title"><span class="title">Github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/welives" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/welives" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/guide/" class="nav-link">
  指南
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端相关" class="dropdown-title"><span class="title">前端相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端相关" class="mobile-dropdown-title"><span class="title">前端相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/guide/前端学习路线.html" class="nav-link">
  前端学习路线
</a></li><li class="dropdown-item"><!----> <a href="/frontend/css-notes/" class="nav-link">
  CSS学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/frontend/js-notes/" class="nav-link">
  JS学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/frontend/uni-app/" class="nav-link">
  uni-app学习笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端相关" class="dropdown-title"><span class="title">后端相关</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端相关" class="mobile-dropdown-title"><span class="title">后端相关</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/backend/eggjs/" class="nav-link router-link-active">
  eggjs学习笔记
</a></li><li class="dropdown-item"><!----> <a href="/backend/thinkphp/" class="nav-link">
  ThinkPHP学习笔记
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Github" class="dropdown-title"><span class="title">Github</span> <span class="arrow down"></span></button> <button type="button" aria-label="Github" class="mobile-dropdown-title"><span class="title">Github</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/welives" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/welives" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>eggjs学习笔记</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/backend/eggjs/" aria-current="page" class="sidebar-link">快速入门</a></li><li><a href="/backend/eggjs/路由.html" class="sidebar-link">路由</a></li><li><a href="/backend/eggjs/控制器.html" class="sidebar-link">控制器</a></li><li><a href="/backend/eggjs/数据库.html" class="sidebar-link">数据库</a></li><li><a href="/backend/eggjs/模型.html" class="active sidebar-link">模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#创建模型" class="sidebar-link">创建模型</a></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#模型其他参数" class="sidebar-link">模型其他参数</a></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#外键约束" class="sidebar-link">外键约束</a></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#关联操作" class="sidebar-link">关联操作</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#一对一" class="sidebar-link">一对一</a></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#一对多" class="sidebar-link">一对多</a></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#多对多" class="sidebar-link">多对多</a></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#关联常用操作" class="sidebar-link">关联常用操作</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#获取器和修改器" class="sidebar-link">获取器和修改器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#模型层-2" class="sidebar-link">模型层</a></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#控制器层-2" class="sidebar-link">控制器层</a></li></ul></li><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#模型钩子" class="sidebar-link">模型钩子</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/eggjs/模型.html#模型层-3" class="sidebar-link">模型层</a></li></ul></li></ul></li><li><a href="/backend/eggjs/常用插件.html" class="sidebar-link">常用插件</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="创建模型"><a href="#创建模型" class="header-anchor">#</a> 创建模型</h2> <ol><li>首先我们来在<code>app/model/</code>目录下编写 user 这个 Model</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/model/user.js</span>
<span class="token string">'use strict'</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize
  <span class="token comment">// 配置（重要：一定要配置详细，一定要！！！）</span>
  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
    <span class="token string">'user'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      name<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      created_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
      updated_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      timestamps<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否自动写入时间戳</span>
      tableName<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token comment">// 自定义数据表名称</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>

  <span class="token keyword">return</span> User
<span class="token punctuation">}</span>
</code></pre></div><p>这个 Model 就可以在 Controller 和 Service 中通过<code>app.model.User</code>或者<code>ctx.model.User</code>访问到了，例如我们编写<code>app/controller/users.js</code></p> <details class="custom-block details"><summary>查看代码</summary> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/users.js</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller

<span class="token keyword">function</span> <span class="token function">toInt</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> str <span class="token operator">===</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> str
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>str<span class="token punctuation">)</span> <span class="token keyword">return</span> str
  <span class="token keyword">return</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx
    <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span> limit<span class="token operator">:</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span> offset<span class="token operator">:</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>offset<span class="token punctuation">)</span> <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span><span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx
    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
    <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">,</span> age <span class="token punctuation">}</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user
  <span class="token punctuation">}</span>

  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx
    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">toInt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findByPk</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span>
      <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> UserController
</code></pre></div></details> <p>最后我们将这个 controller 挂载到路由上</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app
  router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token string">'/users'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>users<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>针对<code>users</code>表的 CURD 操作的接口就开发完了</p> <h2 id="模型其他参数"><a href="#模型其他参数" class="header-anchor">#</a> 模型其他参数</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 配置（重要）</span>
<span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
  <span class="token string">'user'</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    created_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    updated_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 自定义表名</span>
    freezeTableName<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    tableName<span class="token operator">:</span> <span class="token string">'xyz_users'</span><span class="token punctuation">,</span>

    <span class="token comment">// 是否需要增加createdAt、updatedAt、deletedAt字段</span>
    timestamps<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">// 不需要createdAt字段</span>
    createdAt<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>

    <span class="token comment">// 将updatedAt字段改个名</span>
    updatedAt<span class="token operator">:</span> <span class="token string">'utime'</span><span class="token punctuation">,</span>

    <span class="token comment">// 将deletedAt字段改名</span>
    <span class="token comment">// 同时需要设置paranoid为true（此种模式下，删除数据时不会进行物理删除，而是设置deletedAt为当前时间</span>
    deletedAt<span class="token operator">:</span> <span class="token string">'dtime'</span><span class="token punctuation">,</span>
    <span class="token comment">// 开启软删除</span>
    paranoid<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="外键约束"><a href="#外键约束" class="header-anchor">#</a> 外键约束</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 迁移文件</span>
queryInterface<span class="token punctuation">.</span><span class="token function">addConstraint</span><span class="token punctuation">(</span><span class="token string">'tableName'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'foreign key'</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">'user_id'</span><span class="token punctuation">,</span>
  references<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">//Required field</span>
    table<span class="token operator">:</span> <span class="token string">'users'</span><span class="token punctuation">,</span>
    field<span class="token operator">:</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  onDelete<span class="token operator">:</span> <span class="token string">'cascade'</span><span class="token punctuation">,</span>
  onUpdate<span class="token operator">:</span> <span class="token string">'cascade'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="关联操作"><a href="#关联操作" class="header-anchor">#</a> 关联操作</h2> <p>Sequelize 支持标准关联关系：<code>一对一</code>、<code>一对多</code>和<code>多对多</code>
为此，Sequelize 提供了<strong>四种</strong>关联类型，并将它们组合起来以创建关联：</p> <ul><li><code>HasOne</code>关联类型，一对一</li> <li><code>BelongsTo</code>关联类型，一对一或反向一对多</li> <li><code>HasMany</code>关联类型，一对多</li> <li><code>BelongsToMany</code>关联类型，多对多</li></ul> <h4 id="定义-sequelize-关联"><a href="#定义-sequelize-关联" class="header-anchor">#</a> 定义 Sequelize 关联</h4> <p>四种关联类型的定义非常相似。假设我们有两个模型<code>A</code>和<code>B</code>。告诉 Sequelize 两者之间的关联仅需要调用一个函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token constant">A</span> <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'A'</span> <span class="token comment">/* ... */</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token constant">B</span> <span class="token operator">=</span> sequelize<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'B'</span> <span class="token comment">/* ... */</span><span class="token punctuation">)</span>

<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span> <span class="token comment">// A 有一个 B</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span> <span class="token comment">// A 属于 B</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">)</span> <span class="token comment">// A 有多个 B</span>
<span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span><span class="token constant">B</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> through<span class="token operator">:</span> <span class="token string">'C'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// A 属于多个 B , 通过联结表 C</span>
</code></pre></div><p>关联的定义顺序是有关系的。换句话说，对于这四种情况，定义顺序很重要。</p> <p>在上述所有示例中，<code>A</code>称为<strong>源</strong>模型，而<code>B</code>称为<strong>目标</strong>模型，此术语很重要。</p> <ul><li><code>A.hasOne(B)</code>关联意味着<code>A</code>和<code>B</code>之间存在一对一的关系，外键在目标模型(<code>B</code>)中定义。</li> <li><code>A.belongsTo(B)</code>关联意味着<code>A</code>和<code>B</code>之间存在一对一的关系，外键在源模型中定义(<code>A</code>)。</li> <li><code>A.hasMany(B)</code>关联意味着<code>A</code>和<code>B</code>之间存在一对多关系，外键在目标模型(<code>B</code>)中定义。</li> <li><code>A.belongsToMany(B, { through: 'C' })</code>关联意味着将表<code>C</code>用作联结表，在<code>A</code>和<code>B</code>之间存在多对多关系。具有外键(例如<code>aId</code>和<code>bId</code>)。Sequelize 将自动创建此模型<code>C</code>(除非已经存在)，并在其上定义适当的外键。</li></ul> <h4 id="创建标准关系"><a href="#创建标准关系" class="header-anchor">#</a> 创建标准关系</h4> <ul><li>创建一个<strong>一对一</strong>关系，<code>hasOne</code>和<code>belongsTo</code>关联一起使用</li> <li>创建一个<strong>一对多</strong>关系，<code>hasMany</code>he<code>belongsTo</code>关联一起使用</li> <li>创建一个<strong>多对多</strong>关系，两个<code>belongsToMany</code>调用一起使用</li></ul> <h3 id="一对一"><a href="#一对一" class="header-anchor">#</a> 一对一</h3> <h4 id="模型层"><a href="#模型层" class="header-anchor">#</a> 模型层</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 一个用户对应一个用户资料</span>

<span class="token comment">// app/model/user.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize
  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    created_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    updated_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 关联关系</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 关联用户资料 一对一</span>
    User<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> User
<span class="token punctuation">}</span>

<span class="token comment">// app/model/userinfo.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize
  <span class="token keyword">const</span> userinfo <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>
    <span class="token string">'userinfo'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      nickname<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">,</span>
      user_id<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 关联用户表</span>
  userinfo<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> userinfo
<span class="token punctuation">}</span>
</code></pre></div><h4 id="控制器层"><a href="#控制器层" class="header-anchor">#</a> 控制器层</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/users.js</span>
<span class="token comment">// 显示单条</span>
<span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据主键查询 查询一条用findOne</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 主表查询字段限制</span>
        attributes<span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 关联查询</span>
        include<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
            <span class="token comment">// 需要查询的模型</span>
            model<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">,</span>
            <span class="token comment">// 副表查询的字段</span>
            attributes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'nickname'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 主表条件</span>
        where<span class="token operator">:</span> <span class="token punctuation">{</span>
            id<span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="一对多"><a href="#一对多" class="header-anchor">#</a> 一对多</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">City</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
City<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> countryCode<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize<span class="token punctuation">,</span> modelName<span class="token operator">:</span> <span class="token string">'city'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Country</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
Country<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">{</span> isoCode<span class="token operator">:</span> Sequelize<span class="token punctuation">.</span><span class="token constant">STRING</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> sequelize<span class="token punctuation">,</span> modelName<span class="token operator">:</span> <span class="token string">'country'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 在这里，我们可以根据国家代码连接国家和城市</span>
Country<span class="token punctuation">.</span><span class="token function">hasMany</span><span class="token punctuation">(</span>City<span class="token punctuation">,</span> <span class="token punctuation">{</span> foreignKey<span class="token operator">:</span> <span class="token string">'countryCode'</span><span class="token punctuation">,</span> sourceKey<span class="token operator">:</span> <span class="token string">'isoCode'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
City<span class="token punctuation">.</span><span class="token function">belongsTo</span><span class="token punctuation">(</span>Country<span class="token punctuation">,</span> <span class="token punctuation">{</span> foreignKey<span class="token operator">:</span> <span class="token string">'countryCode'</span><span class="token punctuation">,</span> targetKey<span class="token operator">:</span> <span class="token string">'isoCode'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="多对多"><a href="#多对多" class="header-anchor">#</a> 多对多</h3> <div class="language-js extra-class"><pre class="language-js"><code>User<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>Project<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Tasks'</span><span class="token punctuation">,</span> through<span class="token operator">:</span> <span class="token string">'worker_tasks'</span><span class="token punctuation">,</span> foreignKey<span class="token operator">:</span> <span class="token string">'userId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
Project<span class="token punctuation">.</span><span class="token function">belongsToMany</span><span class="token punctuation">(</span>User<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token keyword">as</span><span class="token operator">:</span> <span class="token string">'Workers'</span><span class="token punctuation">,</span> through<span class="token operator">:</span> <span class="token string">'worker_tasks'</span><span class="token punctuation">,</span> foreignKey<span class="token operator">:</span> <span class="token string">'projectId'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="关联常用操作"><a href="#关联常用操作" class="header-anchor">#</a> 关联常用操作</h3> <details class="custom-block details"><summary>查看代码</summary> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取关联模型对象，n对一不需要加s</span>
<span class="token keyword">let</span> userinfo <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getUserinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// n对多需要加s</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 关联操作</span>
<span class="token comment">// 1：用户创建文章（一对多）</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  title<span class="token operator">:</span> <span class="token string">'第一篇文章'</span><span class="token punctuation">,</span>
  user_id<span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 2.获取当前用户所有文章</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    title<span class="token operator">:</span> <span class="token string">'测试'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 3：用户删除文章（一对多）</span>
<span class="token comment">// (1) 获取当前用户的所有文章</span>
<span class="token keyword">let</span> posts <span class="token operator">=</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">getPosts</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  attributes<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
posts <span class="token operator">=</span> posts<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Post<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> posts<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 场景三：用户关注话题（多对多）</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicUser<span class="token punctuation">.</span><span class="token function">bulkCreate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    user_id<span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    topic_id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    user_id<span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    topic_id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">// 用户关注话题（多对多）</span>
<span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>TopicUser<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  where<span class="token operator">:</span> <span class="token punctuation">{</span>
    user_id<span class="token operator">:</span> user<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
    topic_id<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></details> <h2 id="获取器和修改器"><a href="#获取器和修改器" class="header-anchor">#</a> 获取器和修改器</h2> <h3 id="模型层-2"><a href="#模型层-2" class="header-anchor">#</a> 模型层</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/model/user.js</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token constant">STRING</span><span class="token punctuation">,</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> <span class="token constant">DATE</span> <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">.</span>Sequelize
  <span class="token keyword">const</span> User <span class="token operator">=</span> app<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span> primaryKey<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> autoIncrement<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token constant">STRING</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 单独字段的getter，查询时都会调用</span>
      <span class="token comment">// this.getDataValue('name') 获取原始值</span>
      <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> age <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'年龄：'</span> <span class="token operator">+</span> age
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token constant">INTEGER</span><span class="token punctuation">,</span>
      <span class="token comment">// 单独字段的setter，新增和更新时调用</span>
      <span class="token comment">// this.setDataValue('name') 设置原始值</span>
      <span class="token function">set</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setDataValue</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> val <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    created_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
    updated_at<span class="token operator">:</span> <span class="token constant">DATE</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 关联用户资料</span>
  User<span class="token punctuation">.</span><span class="token function-variable function">associate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">models</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">hasOne</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>model<span class="token punctuation">.</span>Userinfo<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> User
<span class="token punctuation">}</span>
</code></pre></div><h3 id="控制器层-2"><a href="#控制器层-2" class="header-anchor">#</a> 控制器层</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据主键查询</span>
    <span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>model<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        where<span class="token operator">:</span> <span class="token punctuation">{</span>
            id<span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取原始值 user.getDataValue('name')</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getDataValue</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="模型钩子"><a href="#模型钩子" class="header-anchor">#</a> 模型钩子</h2> <h3 id="模型层-3"><a href="#模型层-3" class="header-anchor">#</a> 模型层</h3> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略部分模型定义代码</span>

  <span class="token comment">// 钩子</span>
  <span class="token comment">// 查询前</span>
  User<span class="token punctuation">.</span><span class="token function">beforeFind</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'查询前'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 查询后</span>
  User<span class="token punctuation">.</span><span class="token function">afterFind</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'查询后'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 新增前</span>
  User<span class="token punctuation">.</span><span class="token function">beforeCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增前'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 新增后</span>
  User<span class="token punctuation">.</span><span class="token function">afterCreate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新增后'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 修改前</span>
  User<span class="token punctuation">.</span><span class="token function">beforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'修改前'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 修改后</span>
  User<span class="token punctuation">.</span><span class="token function">afterUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'修改后'</span><span class="token punctuation">)</span> <span class="token comment">// 真正修改才会触发，数据相同不会触发</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 删除前</span>
  User<span class="token punctuation">.</span><span class="token function">beforeDestroy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除前'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 删除后</span>
  User<span class="token punctuation">.</span><span class="token function">afterDestroy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user<span class="token punctuation">,</span> option</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除后'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> User
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/10/2020, 11:17:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/eggjs/数据库.html" class="prev">
        数据库
      </a></span> <span class="next"><a href="/backend/eggjs/常用插件.html">
        常用插件
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c6a61154.js" defer></script><script src="/assets/js/2.b83c1193.js" defer></script><script src="/assets/js/17.7c6a7aa9.js" defer></script>
  </body>
</html>
